<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Correction PDF â€” Argali</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
pdfjsLib.GlobalWorkerOptions.workerSrc =
"https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
</script>

<style>
body { margin:0; background:#eee; font-family:Arial; }

/* MENU */
#topMenu {
    display:flex; gap:20px; padding:12px;
    background:white; border-bottom:1px solid #aaa;
    align-items:center; position:relative; z-index:1000;
}
.menuBtn {
    font-size:22px; padding:8px 20px;
    background:white; border:2px solid #999;
    border-radius:8px; cursor:pointer;
}
.menuBtn.active {
    background:#1d5fa8; color:white; border-color:#0a2d47;
}

/* DROPDOWN */
.dropdown {
    position:absolute; background:white; border:2px solid #aaa;
    padding:10px; border-radius:8px; display:none;
    flex-direction:column; gap:8px;
}
.dropdown button {
    padding:8px 10px; border:2px solid #ccc;
    background:white; border-radius:6px; cursor:pointer;
}

/* PDF VIEW */
#pdfWrapper {
    width:80vw; height:85vh;
    margin:20px auto; background:white;
    border:2px solid #aaa; overflow:scroll; position:relative;
}
#pdfCanvas { position:absolute; top:0; left:0; }
.correctionCanvas { position:absolute; }

/* SELECTION */
#selection {
    position:absolute; border:2px dashed red;
    display:none; pointer-events:none;
}

#pageNav { margin-left:auto; display:flex; gap:10px; }
</style>
</head>

<body>

<!-- MENU -->
<div id="topMenu">

    <!-- ZOOM -->
    <button id="btnZoom" class="menuBtn">ðŸ”Ž</button>
    <div id="dropZoom" class="dropdown">
        <button data-zoom="in">Zoom +</button>
        <button data-zoom="out">Zoom â€“</button>
        <button data-zoom="reset">Reset</button>
    </div>

    <!-- CORRECTIF -->
    <button id="btnCorrectif" class="menuBtn">?</button>
    <div id="dropCorrectif" class="dropdown">
        <button data-mode="select">SÃ©lectionner zone</button>
        <button data-mode="showall">Afficher toutes</button>
        <button data-mode="eraseall">Effacer tout</button>
        <button data-mode="eraser">ðŸ§½ Gomme</button>
    </div>

    <!-- NAVIGATION -->
    <div id="pageNav">
        <button id="prevPage">â—€</button>
        <input id="pageInput" type="number" value="1" style="width:60px">
        <button id="goPage">Aller</button>
        <button id="nextPage">â–¶</button>
        <span id="pageInfo"></span>
    </div>
</div>

<!-- PDF ZONE -->
<div id="pdfWrapper">
    <canvas id="pdfCanvas"></canvas>
    <div id="selection"></div>
</div>

<script>
/* ===========================
   VARIABLES
   =========================== */

let pdfDoc = null;
let calqueDoc = null;
let currentPage = 1;

let pdfScale = 1.5;
let originalScale = 1.5;

let mode = "none";          // select / none
let eraserMode = false;     // gomme
let isSelecting = false;    // cadre actif

let sx = 0, sy = 0;         // dÃ©but sÃ©lection

let corrections = {};       // stockage correctifs

const wrapper   = document.getElementById("pdfWrapper");
const pdfCanvas = document.getElementById("pdfCanvas");
const ctx       = pdfCanvas.getContext("2d");
const selection = document.getElementById("selection");


/* ===========================
   CHARGEMENT DES PDF
   =========================== */

async function loadPDFs() {
    pdfDoc    = await pdfjsLib.getDocument("Ken Doe 2 LC p001-088.pdf").promise;
    calqueDoc = await pdfjsLib.getDocument("nÃ©erlandais.pdf").promise;

    renderPage(currentPage);
}
loadPDFs();


/* ===========================
   AFFICHAGE DES PAGES
   =========================== */

async function renderPage(num) {
    const page = await pdfDoc.getPage(num);
    const vp   = page.getViewport({ scale: pdfScale });

    pdfCanvas.width  = vp.width;
    pdfCanvas.height = vp.height;

    await page.render({
        canvasContext: ctx,
        viewport: vp
    }).promise;

    pageInfo.textContent = `Page ${num} / ${pdfDoc.numPages}`;

    // Retirer anciens correctifs
    document.querySelectorAll(".correctionCanvas").forEach(c => c.remove());

    // RÃ©-afficher correctifs si existe
    if (corrections[num]) {
        for (const c of corrections[num]) {
            drawCorrectif(c);
        }
    }
}


/* ===========================
   DESSIN D'UN CORRECTIF EXISTANT
   =========================== */

function drawCorrectif(c) {
    let cv = document.createElement("canvas");
    cv.classList.add("correctionCanvas");

    cv.width  = c.w * pdfScale / originalScale;
    cv.height = c.h * pdfScale / originalScale;

    cv.style.left = (c.x * pdfScale / originalScale) + "px";
    cv.style.top  = (c.y * pdfScale / originalScale) + "px";

    let img = new Image();
    img.src = c.image;
    img.onload = () =>
        cv.getContext("2d").drawImage(img, 0, 0, cv.width, cv.height);

    // gomme
    cv.onclick = () => {
        if (!eraserMode) return;

        cv.remove();
        corrections[currentPage] =
            corrections[currentPage].filter(x => x !== c);
    };

    wrapper.appendChild(cv);
}


/* ===========================
   NAVIGATION PAGES
   =========================== */

prevPage.onclick = () => {
    if (currentPage > 1) {
        currentPage--;
        renderPage(currentPage);
    }
};
nextPage.onclick = () => {
    if (currentPage < pdfDoc.numPages) {
        currentPage++;
        renderPage(currentPage);
    }
};
goPage.onclick = () => {
    let p = parseInt(pageInput.value);
    if (p < 1) p = 1;
    if (p > pdfDoc.numPages) p = pdfDoc.numPages;
    currentPage = p;
    renderPage(p);
};


/* ===========================
   MENUS DÃ‰ROULANTS
   =========================== */

function openMenu(btn, menu) {
    dropZoom.style.display      = "none";
    dropCorrectif.style.display = "none";

    const r = btn.getBoundingClientRect();
    menu.style.left = r.left + "px";
    menu.style.top  = r.bottom + 5 + "px";

    menu.style.display = "flex";
}

btnZoom.onclick      = () => openMenu(btnZoom, dropZoom);
btnCorrectif.onclick = () => openMenu(btnCorrectif, dropCorrectif);


/* ===========================
   CORRECTIF â€“ ACTIONS
   =========================== */

dropCorrectif.querySelectorAll("button").forEach(btn => {
    btn.onclick = () => {
        dropCorrectif.style.display = "none";
        btnCorrectif.classList.add("active");
        btnZoom.classList.remove("active");

        let action = btn.dataset.mode;

        if (action === "select") {
            mode = "select";
            eraserMode = false;
        }
        if (action === "showall") {
            renderPage(currentPage);
        }
        if (action === "eraseall") {
            corrections = {};
            renderPage(currentPage);
        }
        if (action === "eraser") {
            mode = "none";
            eraserMode = true;
        }
    };
});


/* ===========================
   ZOOM â€“ ACTIONS
   =========================== */

dropZoom.querySelectorAll("button").forEach(btn => {
    btn.onclick = () => {
        dropZoom.style.display = "none";
        btnZoom.classList.add("active");
        btnCorrectif.classList.remove("active");

        let action = btn.dataset.zoom;

        if (action === "in")    pdfScale *= 1.15;
        if (action === "out")   pdfScale /= 1.15;
        if (action === "reset") pdfScale  = originalScale;

        renderPage(currentPage);
    };
});


/* ===========================
   UTILITAIRE : position
   =========================== */

function getPos(e) {
    const r = wrapper.getBoundingClientRect();

    if (e.touches) {
        return {
            x: (e.touches[0].clientX - r.left) + wrapper.scrollLeft,
            y: (e.touches[0].clientY - r.top)  + wrapper.scrollTop
        };
    }
    return {
        x: (e.clientX - r.left) + wrapper.scrollLeft,
        y: (e.clientY - r.top)  + wrapper.scrollTop
    };
}


/* ===========================
   1 DOIGT = SÃ‰LECTION
   2 DOIGTS = SCROLL
   =========================== */

/*** START ***/
function startSelect(pos) {
    sx = pos.x;
    sy = pos.y;

    selection.style.left   = sx + "px";
    selection.style.top    = sy + "px";
    selection.style.width  = "0px";
    selection.style.height = "0px";
    selection.style.display = "block";

    isSelecting = true;
}

/*** MOVE ***/
function moveSelect(pos) {
    if (!isSelecting) return;

    selection.style.left   = Math.min(sx, pos.x) + "px";
    selection.style.top    = Math.min(sy, pos.y) + "px";
    selection.style.width  = Math.abs(pos.x - sx) + "px";
    selection.style.height = Math.abs(pos.y - sy) + "px";
}

/*** END ***/
async function endSelect() {
    if (!isSelecting) return;
    isSelecting = false;

    selection.style.display = "none";

    let x = parseFloat(selection.style.left)   / pdfScale * originalScale;
    let y = parseFloat(selection.style.top)    / pdfScale * originalScale;
    let w = parseFloat(selection.style.width)  / pdfScale * originalScale;
    let h = parseFloat(selection.style.height) / pdfScale * originalScale;

    if (w < 5 || h < 5) return;

    // EXTRACTION
    const page = await calqueDoc.getPage(currentPage);
    const vp   = page.getViewport({ scale: originalScale });

    let temp = document.createElement("canvas");
    temp.width  = vp.width;
    temp.height = vp.height;

    let tctx = temp.getContext("2d");

    await page.render({
        canvasContext: tctx,
        viewport: vp
    }).promise;

    let imgData = tctx.getImageData(x, y, w, h);

    let cv = document.createElement("canvas");
    cv.classList.add("correctionCanvas");

    cv.width  = w * pdfScale / originalScale;
    cv.height = h * pdfScale / originalScale;

    cv.style.left = (x * pdfScale / originalScale) + "px";
    cv.style.top  = (y * pdfScale / originalScale) + "px";

    cv.getContext("2d").putImageData(imgData, 0, 0);

    let corr = { x, y, w, h, image: cv.toDataURL() };

    cv.onclick = () => {
        if (!eraserMode) return;
        cv.remove();
        corrections[currentPage] =
            corrections[currentPage].filter(z => z !== corr);
    };

    wrapper.appendChild(cv);

    if (!corrections[currentPage]) corrections[currentPage] = [];
    corrections[currentPage].push(corr);
}


/* ===========================
   SOURIS
   =========================== */

wrapper.addEventListener("mousedown", e => {
    if (mode !== "select") return;
    startSelect(getPos(e));
});
wrapper.addEventListener("mousemove", e => moveSelect(getPos(e)));
wrapper.addEventListener("mouseup", endSelect);


/* ===========================
   TOUCH
   =========================== */

wrapper.addEventListener("touchstart", e => {
    if (e.touches.length === 2) {
        // 2 doigts = scroll naturel â†’ on ne sÃ©lectionne pas
        isSelecting = false;
        return;
    }

    if (e.touches.length === 1 && mode === "select") {
        startSelect(getPos(e));
    }
});

wrapper.addEventListener("touchmove", e => {
    if (e.touches.length === 2) {
        // scroll normal â†’ ne rien bloquer
        return;
    }

    if (mode === "select" && e.touches.length === 1) {
        e.preventDefault();
        moveSelect(getPos(e));
    }
}, { passive: false });

wrapper.addEventListener("touchend", e => endSelect());
</script>

</body>
</html>
